#!/bin/sh /etc/rc.common
START=90
STOP=10
USE_PROCD=1

# Persistent data directory (survives reboots, unlike /var which is tmpfs)
# This stores credentials, keys, and configuration
DATA_DIR="/etc/nym-vpnd/data"

# Log directory (volatile is fine for logs)
LOG_DIR="/var/log/nym-vpnd"

start_service() {
    # Create persistent data directory with secure permissions
    mkdir -p "$DATA_DIR"
    chmod 700 "$DATA_DIR"

    # Create log directory
    mkdir -p "$LOG_DIR"

    procd_open_instance
    procd_set_param command /usr/sbin/nym-vpnd

    # Set environment variables for persistent storage
    procd_set_param env \
        NYM_VPND_DATA_DIR="$DATA_DIR" \
        NYM_VPND_LOG_DIR="$LOG_DIR"

    # Respawn after 60 seconds if crashed, max 5 retries within 3600 seconds
    procd_set_param respawn 3600 60 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile /var/run/nym-vpnd.pid
    procd_close_instance
}

stop_service() {
    /usr/bin/nym-vpnc disconnect 2>/dev/null || true
}
